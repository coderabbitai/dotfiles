#!/bin/bash

function revolver_stop() {
	revolver stop
	tput cnorm
}

# show the list of modified git files that will be committed
echo " == Modified files == "
git status --short --untracked-files=no

# empty line
echo ""

# list only the untracked files and exclude all tracked files from the list
echo " == Untracked files == "
git ls-files --others --exclude-standard

if ! gum confirm "Commit and push these changes?"; then
	echo "Aborting"
	exit 1
fi

# This script takes one argument and uses it as git commit message
if [ $# -ne 1 ]; then
	type=$(gum choose "fix" "feat" "docs" "style" "refactor" "test" "chore" "revert")
	commit_message=$(gum input --value "$type: " --placeholder "Commit message")
else
	commit_message=$1
fi

tput civis
revolver --style 'dots2' start 'Committing changes...'

# Iteration counter
i=0
# Try committing periodically until it works. Time the commit command. Break if it fails instantly
while true; do
	# Increment iteration counter
	i=$((i + 1))

	revolver update "Committing... Try #$i"

	START=$(date +%s)
	git commit -a -m "$commit_message"
	exit_code=$?
	END=$(date +%s)
	DIFF=$((END - START))

	if [ $exit_code -eq 0 ]; then
		echo "Current iteration took $DIFF seconds"
		break
	fi

	echo "Failed attempt took $DIFF seconds"
	if [ $DIFF -lt 4 ]; then
		echo "Commit failed instantly, aborting"
		revolver_stop
		exit 1
	fi
	# break after 3 attempts
	if [ $i -eq 3 ]; then
		echo "Commit failed after 3 attempts, aborting"
		revolver_stop
		exit 1
	fi

	echo "Commit failed, retrying"
done

revolver update "Pulling changes..."
git pull --rebase -q origin "$(git rev-parse --abbrev-ref HEAD)"

revolver update "Pushing changes..."
git push -u -q origin "$(git rev-parse --abbrev-ref HEAD)"

revolver_stop
